# 1.0.0 Release Plan – Encoder Modernization & Secure Enforcement

## Context
- Objective: graduate to `1.0.0` with deliberate breaking changes that tighten standards compliance: modern percent-encoding and strict enforcement of `SameSite=None` requiring `secure` unless explicitly overridden for local development.
- Rationale: `escape()`/`unescape()` are deprecated; `encodeURIComponent` aligns with current spec expectations. Browsers already reject insecure `SameSite=None`, so throwing early surfaces failures sooner. The new override mirrors Amplify’s approach while keeping the library minimal.

## Task 1 – Runtime Encoding Overhaul
- **File:** `index.js`
- **Lines ~19–27:** replace `escape` usages with `encodeURIComponent` except for legacy compatibility on attribute names which remain ASCII.
  ```javascript
    var s = encodeURIComponent(key) + "=" + encodeURIComponent(value);
  ```
  and for options:
  ```javascript
    if (opts.path) s += "; path=" + encodeURIComponent(opts.path);
    if (opts.domain) s += "; domain=" + encodeURIComponent(opts.domain);
    if (opts.MaxAge !== undefined) s += "; Max-Age=" + String(opts.MaxAge);
    if (opts.SameSite) s += "; SameSite=" + opts.SameSite;
  ```
  *Reasoning:* values and most attributes must be percent-encoded; SameSite tokens are case-sensitive literals per spec, so keep as-is. Use `String()` for numeric Max-Age to avoid encoding digits.
- **Line 31 (`clear` helper):** ensure call still functions; no change needed because it delegates to `set`.
- **Add fallback decode function:** near line 6 define `function decodeValue(value) { return value ? decodeURIComponent(value) : value; }`, update `self.get` (lines 7–14) to call `decodeURIComponent` instead of `unescape`.
  ```javascript
      var k = decodeURIComponent(ps[0]);
      if (k === key) return ps[1] ? decodeURIComponent(ps[1]) : undefined;
  ```
  *Reasoning:* maintain symmetric encoding/decoding with modern APIs.

## Task 2 – Enforce SameSite=None Requires Secure
- **File:** `index.js`
- **Modify `shouldWarnInsecureSameSiteNone` helper and config (added in 0.3.1).** Add new flag `allowInsecureSameSiteNone` defaulting to `false` and provide separate behavior:
  ```javascript
  var globalConfig = {
    suppressInsecureSameSiteNoneWarning: false,
    allowInsecureSameSiteNone: false
  };
  ```
- **Inside `self.set` before serialization:**
  ```javascript
    if (opts.SameSite === "None" && !opts.secure && !globalConfig.allowInsecureSameSiteNone) {
      throw new Error("[cookie-cutter] SameSite=None cookies must set secure=true (set allowInsecureSameSiteNone to override)");
    }
  ```
- **Update `exports.configure` (lines ~45–50):** accept `{ allowInsecureSameSiteNone?: boolean }` and set it when true. Keep warning suppression for compatibility.
  *Reasoning:* shift from warnings to hard enforcement while maintaining explicit opt-out for localhost/test use cases.

## Task 3 – TypeScript Adjustments
- **File:** `@types/cookie-cutter.d.ts`
- **Extend `CookieOptions` comment:** note encoding semantics do not change for callers (they still pass strings).
- **Update module config type:**
  ```typescript
  type CookieConfig = {
    suppressInsecureSameSiteNoneWarning?: boolean;
    allowInsecureSameSiteNone?: boolean;
  };

  declare function cookie(doc?: Document | string): Cookie;
  declare namespace cookie {
    function configure(options: CookieConfig): void;
    ...
  }
  ```
  *Reasoning:* expose the new override to TypeScript users and clarify option meanings.

## Task 4 – Documentation Updates
- **File:** `README.md`
- Replace the current “Release Highlights (0.3.x)” section with a 1.0.0-focused list that covers encoder modernization and strict SameSite enforcement, keeping the single-line bullet format.
- Introduce a “Breaking Changes from 0.3.x → 1.0.0” section immediately below the highlights, calling out the secure requirement and encoding differences, and include a compact migration snippet showing how to decode legacy cookie values if needed.
- Extend the `cookie.set` documentation to note that `SameSite: "None"` now throws unless `secure: true` or `allowInsecureSameSiteNone` is configured, and document the expanded `cookie.configure` signature.
- Refresh examples to include both the enforced secure usage and the explicit `cookie.configure({ allowInsecureSameSiteNone: true })` development override, matching the current Examples structure.

## Task 5 – Tests
- **File:** `test/cookie.test.js`
- **Update existing tests:** ensure they expect `encodeURIComponent` output (e.g., `path=%2F`).
- **Add regression tests:**
  1. `SameSite=None` without secure should throw; wrap in `t.throws`.
  2. When `cookie.configure({ allowInsecureSameSiteNone: true })` run, the same call succeeds.
  3. Ensure `get` properly decodes encoded values (`api.set("name", "a b+", { path: "/" });` then `api.get("name") === "a b+"`).
- **If tests rely on warning config:** adjust to reset global config between runs to avoid bleed.

## Task 6 – Release Communications
- **Files:** `docs/UPGRADE-1.0.md` (new) summarizing breaking changes, and append release notes template in `.github/workflows/publish.yml` or `docs/RELEASE_NOTES.md` to mention the encoder change. Not strictly necessary for runtime but critical for community adoption.

## Verification
- Run `npm test` after updates and add new fixtures if needed.
- Consider manual smoke: run provided Node snippet (from AGENTS.md) to confirm real-world deletion works post-encoding change.
