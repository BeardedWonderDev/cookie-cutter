# 0.3.1 Release Plan – Spec Alignment & Warnings

## Context
- Goal: deliver a non-breaking `0.3.1` that aligns with Mozilla’s Set-Cookie guidance (Partitioned CHIPS attribute) while preparing users for the enforced `SameSite=None`+`Secure` pairing coming in `1.0.0`.
- Rationale: Mozilla and RFC6265bis now recognise `Partitioned`; browsers silently drop `SameSite=None` cookies missing `Secure`, which currently leads to confusing failures. Warn now, enforce later to avoid surprising developers.

## Task 1 – Runtime Updates
- **File:** `index.js`
- **Insert at line 5:** introduce shared config + helper.
  ```javascript
  var globalConfig = { suppressInsecureSameSiteNoneWarning: false };

  function shouldWarnInsecureSameSiteNone(opts) {
    if (!opts) return false;
    if (opts.SameSite !== "None") return false;
    if (opts.secure) return false;
    if (globalConfig.suppressInsecureSameSiteNoneWarning) return false;
    if (typeof console === "undefined" || typeof console.warn !== "function") return false;
    if (typeof process !== "undefined" && process.env && process.env.NODE_ENV === "production") return false;
    return true;
  }
  ```
  *Reasoning:* keep warnings opt-out for local HTTP flows; skip noise in production builds.
- **Modify lines 17–27:** update `self.set` to append `Partitioned` and emit warning before assignment.
  ```javascript
    if (opts.partitioned) s += "; Partitioned";
    if (shouldWarnInsecureSameSiteNone(opts)) {
      console.warn("[cookie-cutter] SameSite=None cookies require secure=true; this will throw in v1.0.0");
    }
  ```
  Place `Partitioned` insertion immediately after the Secure flag check (current line 25) to match attribute ordering.
- **Add after line 49:** expose a minimal configuration surface.
  ```javascript
  exports.configure = function (options) {
    if (!options) return;
    if (options.suppressInsecureSameSiteNoneWarning === true) {
      globalConfig.suppressInsecureSameSiteNoneWarning = true;
    }
  };
  ```
  *Reasoning:* allows dev servers to silence the warning while keeping API tiny and forward-compatible with the planned `allowInsecureSameSiteNone` override in 1.0.

## Task 2 – TypeScript Definitions
- **File:** `@types/cookie-cutter.d.ts`
- **Line 8:** add `partitioned?: boolean;` to `CookieOptions`.
- **Line 17:** document new module-level `configure`.
  ```typescript
  interface CookieOptions {
    ...
    partitioned?: boolean;
  }

  interface CookieModule {
    (doc?: Document | string): Cookie;
    configure(options: { suppressInsecureSameSiteNoneWarning?: boolean }): void;
    get: typeof cookie.get;
    set: typeof cookie.set;
    clear: typeof cookie.clear;
  }
  ```
- **Update module export block (lines 23–37)** to reflect `configure` and the refined type. *Reasoning:* ensure TS users discover the new option and configuration hook.

## Task 3 – Documentation
- **File:** `README.md`
- **After line 50 (clear example):** add a subsection “SameSite=None & Secure” explaining the warning, with code showing how to set `secure: true` and how to silence warnings in local dev using `require("…").configure({ suppressInsecureSameSiteNoneWarning: true })`.
- **Add to examples section (~line 62):** include a snippet demonstrating `{ partitioned: true, secure: true, SameSite: "None" }` for CHIPS.
- **Add a note near install section:** call out that `1.0.0` will enforce `Secure` for `SameSite=None`. *Reasoning:* prepare consumers for the upcoming breaking change and document the new attribute.

## Task 4 – Tests
- **File:** `test/cookie.test.js`
- **Add new test block after existing ones:**
  ```javascript
  test("adds Partitioned attribute", function (t) {
    t.plan(1);
    var doc = { cookie: "" };
    var api = cookie(doc);

    var result = api.set("chip", "state", { secure: true, SameSite: "None", partitioned: true });
    t.ok(/; Partitioned/.test(result), "serializes Partitioned attr");
  });
  ```
- **Add warning test:** monkey-patch `console.warn`, call `api.set("sid", "1", { SameSite: "None" })`, assert warning fired, then set `cookie.configure({ suppressInsecureSameSiteNoneWarning: true })` and verify a second call stays silent. Restore console afterward. *Reasoning:* lock down warning behavior and opt-out semantics.

## Task 5 – Future 1.0 Notes (record only)
- After `0.3.1` ships, plan `1.0.0` to replace `escape`/`unescape` with `encodeURIComponent`/`decodeURIComponent`, enforce `SameSite=None` + `Secure` (throw unless `secure: true` or override configured), and document migration steps. This note provides context for why current warning text references the upcoming change.

